<svg
  viewBox="<%= presenter.view_box %>"
  class="hex-svg"
>
  <!-- PASS 1: base outlines -->
  <g>
    <% hexes.each do |h| %>
      <% cx, cy = presenter.center_px(h) %>
      <% points = presenter.hex_points(cx, cy) %>
      <polygon
        points="<%= points %>"
        fill="none"
        stroke="#5a5a5a"
        stroke-width="2"
        stroke-linejoin="round"
      />
    <% end %>
  </g>

  <% hexes.each do |h| %>
    <% cx, cy = presenter.center_px(h) %>
    <% points = presenter.hex_points(cx, cy) %>

    <% revealed = presenter.revealed?(h) %>
    <% spell = revealed ? run.spell_for(h) : nil %>
    <% name = (revealed && spell) ? spell["name"] : "???" %>

    <% st = presenter.style_for(h) %>
    <% is_available = presenter.available?(h) %>
    <% unlockable = presenter.active? && is_available %>

    <% href =
      if unlockable
        unlock_run_path(run, hex_id: h.id)
      else
        run_path(run, hex_id: h.id)
      end
    %>

    <% tooltip =
      if revealed && spell
        [
          name,
          "Unlock Cost: #{format_cost(spell['cost'])}",
          ("Tags: #{Array(spell['tags']).join(', ')}" if spell["tags"].present?)
        ].compact.join("\n")
      else
        "Unknown Spell"
      end
    %>

    <% is_selected = selected_hex.present? && selected_hex.id == h.id %>
    <% lines = hex_label_lines(name, max_chars_per_line: 12) %>
    <% fs = hex_font_size(name) %>

    <a href="<%= href %>" class="hex-link">
      <!-- PASS 2: fill -->
      <polygon points="<%= points %>" fill="<%= st[:fill] %>" stroke="none">
        <title><%= tooltip %></title>
      </polygon>

      <!-- PASS 3: state outline -->
      <polygon
        points="<%= points %>"
        fill="none"
        stroke="<%= st[:stroke] %>"
        stroke-width="4"
        stroke-linejoin="round"
      />

      <!-- selection outline -->
      <% if is_selected %>
        <polygon
          points="<%= points %>"
          fill="none"
          stroke="#1b1b1b"
          stroke-width="2"
          stroke-dasharray="6 4"
          stroke-linejoin="round"
        />
      <% end %>

      <!-- label -->
      <text
        x="<%= cx.round(2) %>"
        y="<%= cy.round(2) %>"
        text-anchor="middle"
        font-size="<%= fs %>"
        fill="#151515"
        style="pointer-events:none; font-family: Georgia, 'Times New Roman', serif;"
      >
        <% if lines.length == 1 %>
          <tspan x="<%= cx.round(2) %>" dy="4"><%= lines[0] %></tspan>
        <% else %>
          <tspan x="<%= cx.round(2) %>" dy="-2"><%= lines[0] %></tspan>
          <tspan x="<%= cx.round(2) %>" dy="12"><%= lines[1] %></tspan>
        <% end %>
      </text>
    </a>
  <% end %>
</svg>
