<% return unless run.active? %>

<%
  unlocked_hexes = run.hexes
  castable = unlocked_hexes.select do |hx|
    spell = run.spell_for(hx)
    next false if spell.blank?

    effect = spell["effect"]
    Array(spell["tags"]).include?("active") &&
      effect.is_a?(Hash) &&
      effect["timing"] == "on_cast"
  end
%>

<% if castable.any? %>
  <div class="panel">
    <div class="panel-head">
      <div class="panel-title">Cast</div>
      <div class="panel-sub">Only unlocked active spells appear here.</div>
    </div>

    <div class="cast-list">
      <% castable.each do |hx| %>
        <% spell = run.spell_for(hx) %>
        <div class="cast-row">
          <div class="cast-main">
            <div class="cast-name"><%= spell["name"] %></div>
            <div class="cast-meta">Cost: <%= format_cost(spell["cast_cost"], effect: spell["effect"]) %></div>
          </div>

          <div class="cast-actions">
            <%= button_to "Cast", cast_run_path(run, hex_id: hx.id), method: :post, class: "btn btn-secondary" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
